# Reference this view as omni_dbt_hr_bi__one_big_table
schema_label: ""

schema: omni_dbt_hr_bi
table_name: ONE_BIG_TABLE

dimensions:
  date_dim:
    sql: '"DATE_DIM"'

  employee_pk:
    sql: '"EMPLOYEE_PK"'

  link_employee_department_pk:
    sql: '"LINK_EMPLOYEE_DEPARTMENT_PK"'

  link_employee_jobrole_pk:
    sql: '"LINK_EMPLOYEE_JOBROLE_PK"'

  link_employee_manager_pk:
    sql: '"LINK_EMPLOYEE_MANAGER_PK"'

  link_employee_country_pk:
    sql: '"LINK_EMPLOYEE_COUNTRY_PK"'

  emp_hashdiff:
    sql: '"EMP_HASHDIFF"'

  emp_start_date:
    sql: '"EMP_START_DATE"'

  end_start_date:
    sql: '"END_START_DATE"'

  employeenumber:
    sql: '"EMPLOYEENUMBER"'

  firstname:
    sql: '"FIRSTNAME"'

  lastname:
    sql: '"LASTNAME"'

  education:
    sql: '"EDUCATION"'

  educationfield:
    sql: '"EDUCATIONFIELD"'

  age:
    sql: '"AGE"'

  gender:
    sql: '"GENDER"'

  maritalstatus:
    sql: '"MARITALSTATUS"'

  joblevel:
    sql: '"JOBLEVEL"'

  yearsincurrentrole:
    sql: '"YEARSINCURRENTROLE"'

  yearssincelastpromotion:
    sql: '"YEARSSINCELASTPROMOTION"'

  yearswithcurrmanager:
    sql: '"YEARSWITHCURRMANAGER"'

  department_pk:
    sql: '"DEPARTMENT_PK"'

  department:
    sql: '"DEPARTMENT"'

  dep_start_date:
    sql: '"DEP_START_DATE"'

  dep_end_date:
    sql: '"DEP_END_DATE"'

  manager_pk:
    sql: '"MANAGER_PK"'

  manager:
    sql: '"MANAGER"'

  man_start_date:
    sql: '"MAN_START_DATE"'

  man_end_date:
    sql: '"MAN_END_DATE"'

  jobrole_pk:
    sql: '"JOBROLE_PK"'

  jobrole:
    sql: '"JOBROLE"'

  role_start_date:
    sql: '"ROLE_START_DATE"'

  role_end_date:
    sql: '"ROLE_END_DATE"'

  country_pk:
    sql: '"COUNTRY_PK"'

  country:
    sql: '"COUNTRY"'

  country_start_date:
    sql: '"COUNTRY_START_DATE"'

  country_end_date:
    sql: '"COUNTRY_END_DATE"'

  dim_start_date:
    sql: '"DIM_START_DATE"'

  dim_end_date:
    sql: '"DIM_END_DATE"'

  cc_start_date:
    sql: '"CC_START_DATE"'

  cc_end_date:
    sql: '"CC_END_DATE"'

  employeecount:
    sql: '"EMPLOYEECOUNT"'

  monthlyincome:
    sql: '"MONTHLYINCOME"'

  bonus_percent:
    sql: '"BONUS_PERCENT"'

  comission:
    sql: '"COMISSION"'

  employee_id:
    sql: '"EMPLOYEE_ID"'
    format: ID

  active:
    sql: '"ACTIVE"'

  days_in_month:
    sql: '"DAYS_IN_MONTH"'

  active_monthlyincome:
    sql: '"ACTIVE_MONTHLYINCOME"'

  dailyincome:
    sql: '"DAILYINCOME"'

  dailybonus:
    sql: '"DAILYBONUS"'

  active_comission:
    sql: '"ACTIVE_COMISSION"'

  dailycomission:
    sql: '"DAILYCOMISSION"'

measures:
  count:
    aggregate_type: count

#The info below was pulled from your dbt repository and is read-only.
dbt:
  name: one_big_table
  target_schema: ANALYTICS
  config:
    schema: HR_BI
    materialized: table
  code: |-
    with filtered_eff_sat_d as (
        select *
            ,max(load_date) over(partition by link_employee_department_pk, start_date) as last_load
        from {{ref('eff__sat_sirh_employee_department')}}
    ),

    filtered_eff_sat_m as (
        select *
            ,max(load_date) over(partition by link_employee_manager_pk, start_date) as last_load
        from {{ref('eff__sat_sirh_employee_manager')}}
    ),

    filtered_eff_sat_j as (
        select *
            ,max(load_date) over(partition by link_employee_jobrole_pk, start_date) as last_load
        from {{ref('eff__sat_sirh_employee_jobrole')}}
    ),

    filtered_eff_sat_c as (
        select *
            ,max(load_date) over(partition by link_employee_country_pk, start_date) as last_load
        from {{ref('eff__sat_sirh_employee_country')}}
    ),

    enriched_sat as (
        select *
            ,lead(effective_from) 
                over(partition by employee_pk 
                order by effective_from) as emp_end_date
        from {{ref('sat_sirh_employee')}}
    ),

    data_before_incremental as (select pit.as_of_date as date_dim
        ,hub.employee_pk
        ,estd.link_employee_department_pk
        ,estj.link_employee_jobrole_pk
        ,estm.link_employee_manager_pk
        ,estc.link_employee_country_pk
        ,ste.hashdiff as emp_hashdiff
        ,ste.effective_from as emp_start_date
        ,coalesce(ste.emp_end_date, to_timestamp('9999-12-31 23:59:59.999999')) as end_start_date
    --    ,lead(ste.effective_from) 
    --        over(partition by hub.employee_pk 
    --        order by ste.effective_from) as emp_end_date
        ,ste.employeenumber
        ,ste.firstname
        ,ste.lastname
        ,ste.education
        ,ste.educationfield
        ,ste.age
        ,ste.gender
        ,ste.maritalstatus
        ,ste.joblevel
        ,ste.yearsincurrentrole
        ,ste.yearssincelastpromotion
        ,ste.yearswithcurrmanager
        ,estd.department_pk
        ,std.department
        ,estd.start_date as dep_start_date
        ,estd.end_date as dep_end_date
        ,estm.manager_pk
        ,stm.manager
        ,estm.start_date as man_start_date
        ,estm.end_date as man_end_date
        ,estj.jobrole_pk
        ,stj.jobrole
        ,estj.start_date as role_start_date
        ,estj.end_date as role_end_date
        ,estc.country_pk
        ,stc.country
        ,estc.start_date as country_start_date
        ,estc.end_date as country_end_date
        ,greatest(emp_start_date, dep_start_date, man_start_date, role_start_date, country_start_date) as dim_start_date
        ,least(emp_end_date, dep_end_date, man_end_date, role_end_date, country_end_date) as dim_end_date
        ,ste.cc_start_date
        ,ste.cc_end_date
        ,ste.employeecount
        ,ste.monthlyincome
        ,ste.bonus_percent
        ,ste.comission

    from {{ref('pit_employee')}} as pit 
    inner join {{ref('hub_employee')}} as hub on (
        pit.employee_pk = hub.employee_pk
    )
    inner join enriched_sat as ste on (
        ste.employee_pk = pit.employee_pk
        and ste.LOAD_DATE = pit.SAT_SIRH_EMPLOYEE_LDTS
    )
    inner join {{ref('link_employee_department')}} as lkd on (
        lkd.employee_pk = pit.employee_pk
    )
    left join filtered_eff_sat_d as estd on (
        hub.employee_pk = estd.employee_pk
        and date_dim >= estd.start_date and date_dim < estd.end_date
        and estd.load_date = estd.last_load
    )
    inner join {{ref('sat_sirh_department')}} as std on (
        estd.department_pk = std.department_pk
    )
    inner join filtered_eff_sat_m as estm on (
        hub.employee_pk = estm.employee_pk
        and date_dim >= estm.start_date and date_dim < estm.end_date
        and estm.load_date = estm.last_load
    )
    inner join {{ref('sat_sirh_manager')}} as stm on (
        estm.manager_pk = stm.manager_pk
    )
    inner join filtered_eff_sat_j as estj on (
        hub.employee_pk = estj.employee_pk
        and date_dim >= estj.start_date and date_dim < estj.end_date
        and estj.load_date = estj.last_load
    )
    inner join {{ref('sat_sirh_jobrole')}} as stj on (
        estj.jobrole_pk = stj.jobrole_pk
    )
    inner join filtered_eff_sat_c as estc on (
        hub.employee_pk = estc.employee_pk
        and date_dim >= estc.start_date and date_dim < estc.end_date
        and estc.load_date = estc.last_load
    )
    inner join {{ref('sat_sirh_country')}} as stc on (
        estc.country_pk = stc.country_pk
    )
    order by date_dim
    ),

    agg_id as (
        select employeenumber
            ,emp_hashdiff
            ,department_pk
            ,manager_pk
            ,jobrole_pk
            ,country_pk
            ,row_number() over(partition by employeenumber order by employeenumber) as id_increment
            ,concat(employeenumber, '_', id_increment) as employee_id
            ,any_value(dim_start_date)
            ,any_value(dim_end_date)
        from data_before_incremental
        group by 1,2,3,4,5,6
    ),

    final as (select data.*
        ,id.employee_id
        ,case 
            when data.date_dim not between data.cc_start_date and data.cc_end_date then false
            else true
        end as active
        ,dat.days_in_month
        ,data.monthlyincome*to_number(active) as active_monthlyincome
        ,active_monthlyincome/days_in_month as dailyincome
        ,dailyincome*data.bonus_percent as dailybonus
        ,data.comission*to_number(active) as active_comission
        ,active_comission/12/days_in_month as dailycomission
    from data_before_incremental as data
    inner join agg_id as id on (
        data.employeenumber = id.employeenumber
        and data.emp_hashdiff = id.emp_hashdiff
        and data.department_pk = id.department_pk
        and data.manager_pk = id.manager_pk
        and data.jobrole_pk = id.jobrole_pk
        and data.country_pk = id.country_pk
    )
    inner join {{ref('as_of_date_month')}} as dat on (
        dat.date_month = left(data.date_dim,7)
    )
    )

    select *
    from final
  referenced_by: [ omni_test, dim_employee, fact_employee_costs, fact_employee_monthly_costs ]
